<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanmati School Election 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .glow {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Voting Section -->
        <div id="voting-section" class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md glow">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-900">Sanmati School Election 2025</h2>
            <!-- Student Details -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Enter Your Details</h3>
                <input id="student-name" type="text" placeholder="Full Name" class="w-full p-2 mb-2 border rounded">
                <select id="student-class" class="w-full p-2 mb-2 border rounded">
                    <option value="" disabled selected>Select Class</option>
                    <option value="6th">6th</option>
                    <option value="7th">7th</option>
                    <option value="8th">8th</option>
                    <option value="9th">9th</option>
                    <option value="10th">10th</option>
                    <option value="11th">11th</option>
                    <option value="12th">12th</option>
                </select>
                <select id="student-section" class="w-full p-2 mb-2 border rounded">
                    <option value="" disabled selected>Select Section</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
                <input id="scholar-number" type="text" placeholder="Scholar Number" class="w-full p-2 mb-2 border rounded">
            </div>
            <!-- Candidates -->
            <h3 class="text-lg font-semibold mb-2">Select Candidates</h3>
            <div id="candidates-list" class="grid grid-cols-1 gap-4"></div>
            <button id="submit-vote" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 mt-4 transition">Submit Vote</button>
            <p id="vote-message" class="text-center mt-2"></p>
            <a id="results-link" href="results.html" class="hidden text-center mt-4 text-blue-500 hover:underline">View Election Results (Admin Only)</a>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Firebase Configuration (Replace with your Firebase project config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const votingSection = document.getElementById('voting-section');
        const candidatesList = document.getElementById('candidates-list');
        const submitVoteBtn = document.getElementById('submit-vote');
        const voteMessage = document.getElementById('vote-message');
        const resultsLink = document.getElementById('results-link');
        const studentName = document.getElementById('student-name');
        const studentClass = document.getElementById('student-class');
        const studentSection = document.getElementById('student-section');
        const scholarNumber = document.getElementById('scholar-number');

        // Sample Candidates (Fallback if Firestore is empty)
        const candidates = [
            { id: '1', name: 'John Doe', position: 'President' },
            { id: '2', name: 'Jane Smith', position: 'President' },
            { id: '3', name: 'Alex Johnson', position: 'Vice President' },
            { id: '4', name: 'Emily Brown', position: 'Vice President' }
        ];

        // Load Candidates
        async function loadCandidates() {
            candidatesList.innerHTML = '';
            try {
                const candidateSnapshot = await getDocs(collection(db, 'candidates'));
                if (candidateSnapshot.empty) {
                    candidates.forEach(candidate => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center p-2 border rounded card';
                        div.innerHTML = `
                            <input type="radio" name="candidate-${candidate.position}" value="${candidate.id}" class="mr-2">
                            <span>${candidate.name} - ${candidate.position}</span>
                        `;
                        candidatesList.appendChild(div);
                    });
                } else {
                    candidateSnapshot.forEach(doc => {
                        const candidate = { id: doc.id, ...doc.data() };
                        const div = document.createElement('div');
                        div.className = 'flex items-center p-2 border rounded card';
                        div.innerHTML = `
                            <input type="radio" name="candidate-${candidate.position}" value="${candidate.id}" class="mr-2">
                            <span>${candidate.name} - ${candidate.position}</span>
                        `;
                        candidatesList.appendChild(div);
                    });
                }
            } catch (error) {
                voteMessage.textContent = 'Error loading candidates: ' + error.message;
            }
        }

        // Check if scholar number has voted
        async function checkIfVoted(scholar) {
            try {
                const voteQuery = await getDocs(collection(db, 'votes'));
                let hasVoted = false;
                voteQuery.forEach(doc => {
                    if (doc.data().scholarNumber === scholar) {
                        hasVoted = true;
                    }
                });
                if (hasVoted) {
                    voteMessage.textContent = 'This scholar number has already voted!';
                    submitVoteBtn.disabled = true;
                } else {
                    submitVoteBtn.disabled = false;
                }
            } catch (error) {
                voteMessage.textContent = 'Error checking vote status: ' + error.message;
            }
        }

        // Check Results Link Visibility (Admin-Only)
        async function checkResultsVisibility() {
            try {
                const configDoc = await getDoc(doc(db, 'config', 'election'));
                if (configDoc.exists() && configDoc.data().showResults === true) {
                    resultsLink.classList.remove('hidden');
                } else {
                    resultsLink.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking results visibility:', error);
                resultsLink.classList.add('hidden'); // Hide link on error
            }
        }

        // Initialize
        loadCandidates();
        checkResultsVisibility();

        // Submit Vote
        submitVoteBtn.addEventListener('click', async () => {
            const name = studentName.value.trim();
            const classGrade = studentClass.value;
            const section = studentSection.value;
            const scholar = scholarNumber.value.trim();

            if (!name || !classGrade || !section || !scholar) {
                voteMessage.textContent = 'Please fill in all student details!';
                return;
            }

            // Check if scholar number has already voted
            await checkIfVoted(scholar);
            if (submitVoteBtn.disabled) return;

            const selectedCandidates = {};
            document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                selectedCandidates[input.name] = input.value;
            });

            if (Object.keys(selectedCandidates).length === 0) {
                voteMessage.textContent = 'Please select at least one candidate!';
                return;
            }

            try {
                const classSection = `${classGrade}_${section}`;
                await setDoc(doc(db, 'votes', scholar), {
                    studentName: name,
                    class: classGrade,
                    section: section,
                    classSection: classSection,
                    scholarNumber: scholar,
                    votes: selectedCandidates,
                    timestamp: new Date()
                });
                voteMessage.textContent = 'Vote submitted successfully!';
                submitVoteBtn.disabled = true;
            } catch (error) {
                voteMessage.textContent = 'Error submitting vote: ' + error.message;
            }
        });
    </script>
</body>
</html>
